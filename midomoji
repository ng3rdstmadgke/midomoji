#!/bin/bash

function usage {
cat >&2 <<EOF
#####################################################################################
# [ usage ]
#   ./midomoji <MODE> [ options ]
#
#   MODE build-dict            辞書のビルド
#        build-matrix          連接コスト表のビルド
#        build-config          設定ファイルのビルド
#        build-pos-info        品詞設定ファイルのビルド
#        build-token-meta-info 形態素のメタ情報オブジェクトをビルド
#        check-dict            辞書のチェックを行う
#        check-matrix          連接コスト表のチェックを行う
#        debug                 デバッグコンソール起動
#        analyze               形態素解析
#
# [ options ]
#   -h        ヘルプ
#
#####################################################################################
EOF
exit 1
}

function errlog {
  MSG=$1
  echo "[Error] $MSG" >&2
  exit 1
}

function infolog {
  MSG=$1
  echo "[Info] $MSG" >&2
}

function file_exists {
for file in $@; do
  if [ ! -r "$file" ]; then
    errlog "$file is not found."
  fi
done
}

SCRIPT_DIR=$(cd $(dirname $0); pwd)
DICT_DIR=$SCRIPT_DIR/dictionary
MORPHEME=$DICT_DIR/morpheme.tsv
MATRIX=$DICT_DIR/matrix.tsv
DICT_BIN=$DICT_DIR/dict.bin
MATRIX_BIN=$DICT_DIR/matrix.bin
CONFIG_BIN=$DICT_DIR/config.bin
POS_INFO_BIN=$DICT_DIR/pos_info.bin
TOKEN_META_INFO_BIN=$DICT_DIR/token_meta_info.bin
ANALYZE_TARGET_FILE=
MODE=
while [ "$#" != 0 ]; do
  if [ "$1" = "-h" ]; then
    usage
  elif [ -z "$MODE" ]; then
    MODE=$1
  elif [ "$MODE" = "analyze" -a -z "$ANALYZE_TARGET_FILE" ]; then
    ANALYZE_TARGET_FILE=$1
  fi
  shift
done

if [ -z "$MODE" ]; then
  usage
fi

JAR_FILE=$SCRIPT_DIR/target/scala-2.12/midomoji.jar
file_exists $JAR_FILE

if [ "$MODE" = "build-dict" ]; then
  file_exists $MORPHEME
  java -jar $JAR_FILE --build-dict $MORPHEME $DICT_BIN
elif [ "$MODE" = "build-matrix" ]; then
  file_exists $MATRIX
  java -jar $JAR_FILE --build-matrix $MATRIX $MATRIX_BIN
elif [ "$MODE" = "build-config" ]; then
  CHAR=$DICT_DIR/char.tsv
  CHAR_TYPE=$DICT_DIR/char_type.tsv
  UNK=$DICT_DIR/unk.tsv
  file_exists $CHAR $CHAR_TYPE $UNK
  java -jar $JAR_FILE --build-config $CHAR $CHAR_TYPE $UNK $CONFIG_BIN
elif [ "$MODE" = "build-pos-info" ]; then
  POS=$DICT_DIR/pos.tsv
  file_exists $POS
  java -jar $JAR_FILE --build-pos-info $POS $POS_INFO_BIN
elif [ "$MODE" = "build-token-meta-info" ]; then
  file_exists $MORPHEME
  java -jar $JAR_FILE --build-token-meta-info $MORPHEME $TOKEN_META_INFO_BIN
elif [ "$MODE" = "check-dict" ]; then
  file_exists $MORPHEME $DICT_BIN
  java -jar $JAR_FILE --check-dict $MORPHEME $DICT_BIN
elif [ "$MODE" = "check-matrix" ]; then
  file_exists $MATRIX $MATRIX_BIN
  java -jar $JAR_FILE --check-matrix $MATRIX $MATRIX_BIN
elif [ "$MODE" = "debug" ]; then
  file_exists $DICT_BIN $MATRIX_BIN $CONFIG_BIN $POS_INFO_BIN $TOKEN_META_INFO_BIN
  java -jar $JAR_FILE --debug $DICT_BIN $MATRIX_BIN $CONFIG_BIN $POS_INFO_BIN $TOKEN_META_INFO_BIN
elif [ "$MODE" = "analyze" ]; then
  file_exists $DICT_BIN $MATRIX_BIN $CONFIG_BIN $POS_INFO_BIN $TOKEN_META_INFO_BIN
  java -jar $JAR_FILE --analyze $DICT_BIN $MATRIX_BIN $CONFIG_BIN $POS_INFO_BIN $TOKEN_META_INFO_BIN $ANALYZE_TARGET_FILE
else
  usage
fi

